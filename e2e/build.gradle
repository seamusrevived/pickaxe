import org.apache.tools.ant.taskdefs.condition.Os

task install(type: Exec) {
    commandLine getYarnCmdForOs(), 'install'
}

task docker_build(type: Exec) {
    dependsOn ':pickaxe-server:jar'
    dependsOn ':pickaxe-server:copy_dependencies'
    dependsOn ':client:build'
    commandLine 'docker', 'build', '..', '-f', '../Dockerfile.from_jar', '-t', 'pickaxe:e2e'
}

task docker_start(type: Exec) {
    dependsOn 'docker_build'
    dependsOn ':client:build'
    dependsOn 'docker_env_is_clean'
    commandLine 'docker', 'run', '-d', '-p', '8080:8080', '--name', 'pickaxe', 'pickaxe:e2e'
}

task docker_stop(type: Exec) {
    commandLine 'docker', 'stop', 'pickaxe'
}

task docker_rm(type: Exec) {
    dependsOn 'docker_stop'
    commandLine 'docker', 'rm', 'pickaxe'
}

task docker_is_not_running(type: Exec){
    commandLine 'docker', 'stop', 'pickaxe'
    ignoreExitValue true
}

task docker_env_is_clean(type: Exec){
    dependsOn 'docker_is_not_running'
    commandLine 'docker', 'rm', 'pickaxe'
    ignoreExitValue true
}

task docker_build_full(type: Exec) {
    dependsOn ':pickaxe-server:copy_dependencies'
    commandLine 'docker', 'build', '..', '-f', '../Dockerfile', '-t', 'pickaxe:full-build-e2e'
}

task docker_start_full(type: Exec) {
    dependsOn 'docker_build_full'
    dependsOn ':client:build'
    dependsOn 'docker_env_is_clean'
    commandLine 'docker', 'run', '-d', '-p', '8080:8080', '--name', 'pickaxe', 'pickaxe:full-build-e2e'
}

task test(type: Exec) {
    dependsOn 'install'
    dependsOn 'docker_start'
    commandLine getYarnCmdForOs(), 'run', 'cypress', 'run'
    finalizedBy 'docker_rm'
}

task full_build_test(type: Exec) {
    dependsOn 'docker_start_full'
    commandLine getYarnCmdForOs(), 'run', 'cypress', 'run'
    finalizedBy 'docker_rm'
}

private static String getYarnCmdForOs() {
    String yarn = 'yarn'
    if (Os.isFamily(Os.FAMILY_WINDOWS)) {
        yarn = 'yarn.cmd'
    }
    yarn
}