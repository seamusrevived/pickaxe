name: CI

on: [push]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-java@v1
      with:
        java-version: '12'

    - name: Get yarn cache
      id: yarn-cache
      run: echo "::set-output name=dir::$(yarn cache dir)"

    - uses: actions/cache@v1
      with:
        path: ${{ steps.yarn-cache.outputs.dir }}
        key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-yarn-
    - uses: actions/cache@v1
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build client
      working-directory: ./client
      run: |
        yarn install
        yarn build
    - name: Test client
      working-directory: ./client
      run: CI=true yarn test

    - name: Server test and build jar
      working-directory: ./server
      run: gradle build

    - name: Build and start docker image
      run: |
        docker build . -t pickaxe
        docker run -d -p 8080:8080 pickaxe

    - name: Integration tests
      run: |
        yarn install
        yarn run cypress run

    - name: Save docker image
      run: docker save pickaxe > pickaxe_latest.tar

    - name: Deploy to development server
      run: |
        eval `ssh-agent -s`
        ssh-add - <<< "${{ secrets.DEVEL_HOST_PRIVATE_KEY }}"
        scp pickaxe_latest.tar ${{ secrets.DEVEL_USER }}@${{ secrets.DEVEL_HOST }}:~
        ssh ${{ secrets.DEVEL_USER }}@${{ secrets.DEVEL_HOST }} date
